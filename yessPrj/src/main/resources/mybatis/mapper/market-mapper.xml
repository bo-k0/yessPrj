<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="marketMapper">
	
	<!-- 마켓 리스트 + 검색 -->
	<select id="list" resultType="MarketVo">
        SELECT 
		    MK.NO
		    , MB.NICK
		    , MK.TITLE
		    , MT.MARKET_TYPE
		    , TO_CHAR(MK.ENROLL_DATE, 'yyyy-mm-dd') AS ENROLL_DATE
		    , MK.HIT
		    , MK.TRADE_YN
		    , MA.CHANGE_NAME
		FROM MARKET MK
		JOIN MEMBER MB ON MK.MEMBER_NO = MB.NO
		JOIN MARKET_TYPE MT ON MK.MARKET_TYPE_NO = MT.NO
		JOIN MARKET_ATTACHMENT MA ON MK.NO = MA.MARKET_NO
		WHERE MK.DELETE_YN = 'N'
		AND MA.THUMB_YN = 'Y'
		<if test=' tradeType != null and tradeType != "" and "0" neq tradeType '>
			AND MARKET_TYPE_NO = ${tradeType}
		</if>
		AND TITLE LIKE '%${tradeName}%'
		ORDER BY MK.NO DESC
	</select>
	
	<!-- 마켓 리스트 갯수 -->
	<select id="listCount" resultType="int">
		SELECT COUNT(*)
		FROM MARKET
	</select>
	
	<!-- 마켓 글 작성 -->
	<insert id="write">
	 	INSERT INTO MARKET
		(
		    NO
		    , MEMBER_NO
		    , TITLE
		    , MARKET_TYPE_NO
		    , OBJECT_NAME
		    , OBJECT_INFO
		    , TRADE_METHOD
		    , OBJECT_PS
		)
		VALUES
		(
		    SEQ_MARKET_NO.NEXTVAL
		    , 1<!-- #{memberNo} -->
		    , #{title}
		    , #{marketType}
		    , #{objectName}
		    , #{objectInfo}
		    , #{tradeMethod}
		    , #{objectPs}
		)
	</insert>
	
	<!-- 마켓 이미지 업로드 -->
	<insert id="writeImg">
		INSERT INTO MARKET_ATTACHMENT
		(
			NO
			, MARKET_NO
			, ORIGIN_NAME
			, CHANGE_NAME
			, FILE_PATH
			, THUMB_YN
		)
		VALUES
		(
		 	SEQ_MARKET_ATTACHMENT_NO.NEXTVAL 
		 	, SEQ_MARKET_NO.CURRVAL
		 	, #{originName}
			, #{changeName}
			, #{filePath}
			, #{thumbYn}
		)
	</insert>
	
	
	<!-- 마켓 상세 (글) -->
	<select id="detail" resultType="MarketVo">
 		SELECT 
		    MK.NO
		    , MB.NICK
		    , MK.TITLE
		    , MT.MARKET_TYPE
		    , TO_CHAR(MK.ENROLL_DATE, 'yyyy-mm-dd') AS ENROLL_DATE
		    , MK.HIT
		    , MK.TRADE_YN
		    , TO_CHAR(MK.MODIFY_DATE, 'yyyy-mm-dd') AS MODIFY_DATE
		    , OBJECT_NAME
		    , OBJECT_INFO
		    , TRADE_METHOD
		    , OBJECT_PS
		FROM MARKET MK
		JOIN MEMBER MB ON MK.MEMBER_NO = MB.NO
		JOIN MARKET_TYPE MT ON MK.MARKET_TYPE_NO = MT.NO
		WHERE DELETE_YN = 'N'
		AND MK.NO = #{NO}
	</select>
	
	<!-- 마켓 상세 (사진) -->
	<select id="detailImg">
 		SELECT 
			CHANGE_NAME
			, FILE_PATH
		FROM MARKET_ATTACHMENT
		WHERE STATUS = 'O'
		AND MARKET_NO = #{no} 
	</select>
	
	<!-- 마켓 상세 (댓글) -->
	<select id="detailCmt">
 		SELECT
			MB.NICK
			, CMT
			, TO_CHAR(MODIFY_DATE, 'yyyy-mm-dd') AS MODIFY_DATE
			, SECRET_YN
		FROM MARKET_CMT MC
		JOIN MEMBER MB ON MC.MEMBER_NO = MB.NO
		WHERE DELETE_YN = 'N'
		
		
	</select>


</mapper>